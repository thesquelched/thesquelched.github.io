
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Easier Two-Factor Authentication in FastMail With Pentadactyl - Watch Out for Scott</title>
  <meta name="author" content="Scott">

  
  <meta name="description" content="I switched to FastMail last month, and so far it&rsquo;s pretty
great (aside from my bayes spam filter not quite working optimally yet).
One of the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://thesquelched.github.io/blog/2014/07/07/easier-two-factor-authentication-in-fastmail-with-pentadactyl">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Watch Out for Scott" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Watch Out for Scott</a></h1>
  
    <h2>He's a Dick</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:thesquelched.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="https://www.dropbox.com/s/fnplqvzqn7sprn4/resume.pdf">Resume</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Easier Two-Factor Authentication in FastMail With Pentadactyl</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-07T11:41:59-05:00" pubdate data-updated="true">Jul 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I switched to <a href="https://www.fastmail.fm">FastMail</a> last month, and so far it&rsquo;s pretty
great (aside from my bayes spam filter not quite working optimally yet).
One of the selling points was that FastMail supports multiple two-factor
authentication providers, including Google Authenticator, which is a must
security-conscious folk like myself.  However, the login process is somewhat
annoying.  The login page looks like this:</p>

<p><img src="http://i.imgur.com/3x7mUT6.png" alt="FastMail Login Screen" /></p>

<p>In order to use two-factor authentication, you need to click the &ldquo;More&rdquo; link,
which reveals the two-factor auth code input.  This feels unnecessary, and it&rsquo;s
particularly annoying to me, a <a href="http://5digits.org/pentadactyl/">Pentadactyl</a>
user, as I have to either grab the mouse and click on the link, or I have to
exit insert mode, search for the &ldquo;More&rdquo; link, hit enter, and then re-enter
insert mode to input the two-factor code.  Also, unlike Gmail, there&rsquo;s no
option to allow an authenticated computer to skip the two-factor auth step in
the future.</p>

<p>FastMail <a href="https://www.fastmail.fm/help/account/2fa.html">openly admits that the process is a pain</a>,
and that they intend to streamline it at some point in the future, but damnit,
I demand satisfaction <em>now</em>.  While there&rsquo;s nothing I can do about the latter
issue, I sure as hell can take care of the former.  Pentadactyl allows you
<a href="http://5digits.org/help/map.xhtml#:command">create custom Javascript commands</a>,
which you can run automatically using
<a href="http://5digits.org/help/autocommands.xhtml">autocommands</a>.  Using these two
features, I should be able to write a command to locate and click the &ldquo;More&rdquo;
link (which is actually a <code>&lt;span&gt;</code> element), which I can then call
automatically on page load with an autocommand.</p>

<p>Let&rsquo;s try the simplest possible approach: get the DOM element corresponding to the link, then call its <code>click</code> method.  This goes in your <code>$HOME/.pentadactylrc</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command! fastmail-twofactor -description "Show FastMail two-factor auth window" -javascript
</span><span class='line'>    \ content.document.querySelector('div.content #problem span').click();
</span><span class='line'>
</span><span class='line'>autocmd DOMLoad www.fastmail.fm :fastmail-twofactor</span></code></pre></td></tr></table></div></figure>


<p>Note that, in order to access <code>document</code>, which would ordinarily be a global
variable, you need to use the <code>content</code> object provided by Pentadactyl.  You
can then reload the configuration using the <code>:rehash</code> or <code>:reh</code> command.
However, upon reloading the page, the dialog is still collapsed.  Manually
running the <code>:fastmail-twofactor</code> command works, though, so there must be a
problem with the autocommand.  The <code>DOMLoad</code> event fires when the page loads,
so the command should work as long as the &ldquo;More&rdquo; link is present on load;  one
way this could fail is if some content is added to the page asynchronously
after the DOM loads.  You can confirm this using the Firefox debugger.  It
turns out that <code>homepage.js</code> is loaded on the page; setting a breakpoint at the
beginning and stepping through the execution reveals that the page loads
without the login window, one to load and display it shortly afterward.</p>

<p>Unfortunately, there&rsquo;s no Pentadactyl event for loading individual objects on
the page, so we&rsquo;ll have to look for a pure Javascript solution.  DOM3, which has been supported by major browsers for a while now, provides the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver">MutationObserver object</a>,
which allows you to observe changes in the DOM.  We should be able to use this
to detect when the &ldquo;More&rdquo; link is added, after which we can trigger the click
event.  However, just to be safe, we should check if the link already exists
beforehand.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command! fastmail-twofactor -description "Show FastMail two-factor auth window" -javascript
</span><span class='line'>    \ var problem = content.document.querySelector('div.content #problem');
</span><span class='line'>    \ 
</span><span class='line'>    \ var more_link = problem.querySelector('span');
</span><span class='line'>    \ if (more_link != null) {
</span><span class='line'>    \   more_link.click();
</span><span class='line'>    \   return;
</span><span class='line'>    \ }
</span><span class='line'>    \
</span><span class='line'>    \ var obs = new MutationObserver(function(mutations) {
</span><span class='line'>    \   mutations.forEach(function(mutation) {
</span><span class='line'>    \     for (var i = 0; i &lt; mutation.addedNodes.length; i++) {
</span><span class='line'>    \       var node = mutation.addedNodes.item(i);
</span><span class='line'>    \       if (node.tagName.toLowerCase() === 'span') {
</span><span class='line'>    \         node.click();
</span><span class='line'>    \         obs.disconnect();
</span><span class='line'>    \       }
</span><span class='line'>    \     };
</span><span class='line'>    \   });
</span><span class='line'>    \ });
</span><span class='line'>    \
</span><span class='line'>    \ obs.observe(problem, {childList: true});
</span><span class='line'>
</span><span class='line'>autocmd DOMLoad www.fastmail.fm :fastmail-twofactor</span></code></pre></td></tr></table></div></figure>


<p>Voila!  The login window now automatically expands when you enter the page.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Scott</span></span>

      








  


<time datetime="2014-07-07T11:41:59-05:00" pubdate data-updated="true">Jul 7<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/fastmail/'>fastmail,</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/pentadactyl/'>pentadactyl,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://thesquelched.github.io/blog/2014/07/07/easier-two-factor-authentication-in-fastmail-with-pentadactyl/" data-via="" data-counturl="http://thesquelched.github.io/blog/2014/07/07/easier-two-factor-authentication-in-fastmail-with-pentadactyl/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/06/21/new-blog/" title="Previous Post: New Blog, Sucka">&laquo; New Blog, Sucka</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/07/easier-two-factor-authentication-in-fastmail-with-pentadactyl/">Easier Two-Factor Authentication in FastMail With Pentadactyl</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/21/new-blog/">New Blog, Sucka</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/thesquelched">@thesquelched</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'thesquelched',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Scott -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
